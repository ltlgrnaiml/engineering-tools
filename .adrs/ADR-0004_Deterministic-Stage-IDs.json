{
  "schema_type": "adr",
  "id": "ADR-0004_Deterministic-Stage-IDs",
  "title": "Deterministic, Content-Addressed Stage IDs for CDU-DAT Pipeline",
  "status": "accepted",
  "date": "2025-01-15",
  "review_date": "2025-07-15",
  "deciders": "Mycahya Eggleston",
  "scope": "subsystem:CDU-DAT",
  "provenance": [
    {
      "at": "2025-01-15",
      "by": "Mycahya Eggleston",
      "note": "Initial decision extracted from stage orchestration vision document"
    },
    {
      "at": "2025-11-22",
      "by": "Mycahya Eggleston",
      "note": "Refactored for explicit coverage of all pipeline stages, collision policy, and reproducibility"
    }
  ],
  "context": "CDU-DAT users frequently unlock and re-lock stages during iterative workflows. Each pipeline stage (Selection, Context, Table Selection, Preview, Parse, Export) must have a stable, reproducible identifier to enable artifact reuse, support accidental unlock recovery, and guarantee reproducibility across machines. Non-deterministic IDs (UUIDs, timestamps, counters) break idempotent re-locks and artifact traceability. Deterministic, content-addressed IDs are required for robust artifact management and auditability.",
  "decision_primary": "Compute all stage IDs (Selection, Context, Table Selection, Preview, Parse, Export) as a SHA-256 hash of a stable JSON serialization of stage inputs plus a fixed seed (default seed=42). Use the first 8 characters of the hash for brevity. Same inputs yield the same stage ID, enabling idempotent re-locks and artifact reuse. If inputs change, a new stage ID is generated, invalidating downstream artifacts as appropriate.",
  "decision_details": {
    "approach": "Content-addressed stage IDs via cryptographic hashing. Inputs are serialized to stable, sorted JSON with no whitespace. The hash is computed using SHA-256 and truncated to 8 characters. The seed is fixed at 42 for determinism, but may be overridden for testing. Export stage IDs include parse_id, selection_id, export options, and environment-independent paths.",
    "constraints": [
      "Determinism: Same inputs and seed must always yield the same stage ID.",
      "Collision Resistance: Different inputs must yield different IDs with high probability.",
      "Stability: Input order must not affect the ID (use sorted keys).",
      "Seed Consistency: Default seed is 42; must be documented and stable across versions.",
      "Artifact Reuse: If a stage ID exists, its artifact must be reused (no re-computation).",
      "Collision Detection: If a stage ID exists with different inputs, raise an error and do not overwrite."
    ],
    "implementation_specs": [
      "SPEC-0014_Deterministic-Stage-Id-Spec",
      "SPEC-0013_Artifact-Lifecycle-Preservation-Spec"
    ]
  },
  "consequences": [
    "Idempotent re-locks: Same inputs yield the same stage ID and artifact reuse.",
    "Accidental unlock recovery: Re-lock with same inputs reuses all downstream artifacts.",
    "Deterministic reproducibility: Same inputs on different machines yield the same stage ID.",
    "Testing support: Configurable seed enables generating different IDs for testing.",
    "Opaque IDs: Users cannot infer inputs from the ID prefix.",
    "Hash collisions: 8-char prefix has a low but nonzero collision risk (mitigated by detection and can be extended if needed)."
  ],
  "alternatives_considered": [
    {
      "name": "UUIDs (uuid.uuid4())",
      "pros": "Guaranteed unique, simple implementation, widely supported.",
      "cons": "Non-deterministic, breaks idempotent re-locks, no artifact reuse.",
      "rejected_reason": "Breaks idempotent re-locks and artifact traceability."
    },
    {
      "name": "Timestamp-Based IDs",
      "pros": "Human-readable, sortable, simple implementation.",
      "cons": "Non-deterministic, no artifact reuse, no reproducibility across machines.",
      "rejected_reason": "Same issues as UUIDs; not suitable for deterministic workflows."
    },
    {
      "name": "Sequential IDs",
      "pros": "Human-readable, simple implementation, compact.",
      "cons": "Non-deterministic, requires global counter, no artifact reuse.",
      "rejected_reason": "Non-deterministic and not suitable for distributed or parallel workflows."
    },
    {
      "name": "MD5 Hash",
      "pros": "Faster than SHA-256, shorter hash, widely supported.",
      "cons": "Cryptographically broken, not future-proof.",
      "rejected_reason": "MD5 is deprecated for security reasons; SHA-256 is industry standard."
    }
  ],
  "tradeoffs": "We trade human-readable IDs for deterministic, content-addressed IDs. We accept a small risk of hash collisions (with 8-char prefix) for brevity, mitigated by collision detection and the option to extend the prefix if needed.",
  "guardrails": [
    {
      "rule": "Determinism: compute_stage_id(inputs, seed) MUST be deterministic (same inputs yield same ID).",
      "enforcement": "Stable JSON serialization with sorted keys and fixed seed; validated in tests.",
      "scope": "subsystem:CDU-DAT"
    },
    {
      "rule": "Collision Detection: If stage ID exists with different inputs, raise an error and do not overwrite.",
      "enforcement": "Backend checks for input hash matches before artifact reuse.",
      "scope": "subsystem:CDU-DAT"
    },
    {
      "rule": "Artifact Reuse: If stage ID exists, MUST reuse artifact (no re-computation).",
      "enforcement": "Backend checks for existing artifact before recomputing.",
      "scope": "subsystem:CDU-DAT"
    }
  ],
  "cross_cutting_guardrails": [
    "Path Safety: All public paths must be relative (see ADR-0017#path-safety)",
    "Idempotency: All mutating requests must be idempotent or safely retryable (see .adrs/cross-cutting/GUARDRAILS.md#idempotency)"
  ],
  "references": [
    "ADR-0001_Hybrid-FSM-Stage-Orchestration",
    "ADR-0002_Artifact-Preservation-on-Unlock",
    ".adrs/cross-cutting/GUARDRAILS.md"
  ],
  "tags": [
    "determinism",
    "idempotency",
    "content-addressing",
    "hashing",
    "artifact-reuse"
  ],
  "affected_components": [
    "backend/src/dramcdu/dat_aggregation/core/id_generator.py",
    "backend/src/dramcdu/dat_aggregation/core/state_machine.py",
    "backend/src/dramcdu/dat_aggregation/core/snapshot_manager.py"
  ]
}
