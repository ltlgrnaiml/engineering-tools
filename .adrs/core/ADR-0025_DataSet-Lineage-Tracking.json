{
  "schema_type": "adr",
  "id": "ADR-0025_DataSet-Lineage-Tracking",
  "title": "Cross-Tool DataSet Lineage and Provenance Tracking",
  "status": "accepted",
  "date": "2024-12-27",
  "review_date": "2025-06-27",
  "deciders": "Mycahya Eggleston",
  "scope": "core",
  "provenance": [
    {
      "at": "2024-12-27",
      "by": "AI Analysis",
      "note": "Initial draft based on platform DataSet requirements"
    },
    {
      "at": "2025-12-27",
      "by": "DevTools Editor",
      "note": "Updated via DevTools ADR Editor"
    }
  ],
  "context": "As data flows through multiple tools (DAT → SOV → PPTX), tracking lineage becomes critical for debugging, reproducibility, and compliance. Each DataSet should know its origin: which tool created it, which input DataSet(s) it derived from, and what transformation was applied. The challenge is designing a lineage model that is simple enough for common cases (single parent) while supporting complex cases (multiple parents, external sources).",
  "decision_primary": "All DataSets track lineage via parent_ref and source_tool fields in DataSetManifest. parent_ref is the ID of the input DataSet (nullable for root datasets from external sources). source_tool is an enum indicating which tool created the DataSet (dat, sov, pptx, external). Lineage is immutable once created. The gateway provides a /lineage endpoint to retrieve the full lineage graph for any DataSet.",
  "decision_details": {
    "approach": "Manifest-based lineage with parent_ref and source_tool fields. Gateway aggregates lineage graph by walking parent_ref chain. External sources have null parent_ref and source_tool='external'.",
    "constraints": [
      "DataSetManifest MUST include parent_ref field (nullable for root datasets)",
      "DataSetManifest MUST include source_tool enum: dat, sov, pptx, external",
      "Lineage is immutable (parent_ref cannot be modified after creation)",
      "Circular lineage references MUST be rejected (validation at save time)",
      "Gateway /lineage endpoint returns full ancestor chain",
      "Multi-parent lineage (joins) uses parent_refs array (future extension)"
    ],
    "implementation_specs": [
      "SPEC-0028_DataSet-Lineage-Spec"
    ]
  },
  "consequences": [
    "Full provenance tracking across tool boundaries",
    "Debugging simplified (can trace data origin)",
    "Compliance supported (audit trail of data transformations)",
    "Immutability prevents lineage tampering",
    "Risk: Lineage queries may be slow for deep graphs (mitigated by caching)",
    "Risk: Multi-parent lineage adds complexity (deferred to future extension)"
  ],
  "alternatives_considered": [
    {
      "name": "No Lineage Tracking",
      "pros": "Simpler, no manifest changes",
      "cons": "Cannot trace data origin, debugging is difficult",
      "rejected_reason": "Fails compliance and debugging requirements"
    },
    {
      "name": "Separate Lineage Database",
      "pros": "Query flexibility, graph database benefits",
      "cons": "Adds database dependency, sync complexity",
      "rejected_reason": "Manifest-based lineage is simpler and sufficient"
    },
    {
      "name": "Full Provenance Graph (All Ancestors Embedded)",
      "pros": "Single read for full lineage",
      "cons": "Manifests grow unbounded, duplication",
      "rejected_reason": "Parent-only lineage is compact; graph computed on demand"
    }
  ],
  "tradeoffs": "We trade query performance (walking parent chain) for storage efficiency (no duplication). Immutability prevents tampering but blocks corrections. Single-parent model is simple but defers multi-parent joins.",
  "guardrails": [
    {
      "rule": "DataSetManifest MUST include parent_ref for derived datasets",
      "enforcement": "ArtifactStore validates non-null parent_ref when source_tool != 'external'",
      "scope": "core",
      "id": "dataset-lineage-parent-ref-required"
    },
    {
      "rule": "Circular lineage references MUST be rejected",
      "enforcement": "ArtifactStore walks parent chain at save time; rejects cycles",
      "scope": "core",
      "id": "dataset-lineage-no-cycles"
    }
  ],
  "cross_cutting_guardrails": [
    "Audit Trail: All lifecycle events must be logged (see ADR-0017#audit-trail)"
  ],
  "references": [
    "ADR-0004_Deterministic-Content-Addressed-IDs: IDs enable lineage tracking",
    "ADR-0001_Guided-Workflow-FSM-Orchestration: Workflows produce DataSets with lineage",
    "shared/contracts/core/dataset.py: DataSetManifest schema",
    "shared/storage/artifact_store.py: Lineage validation on save",
    "gateway/services/dataset_service.py: Lineage query endpoint"
  ],
  "tags": [
    "dataset",
    "lineage",
    "provenance",
    "cross-tool"
  ],
  "affected_components": [
    "shared/contracts/core/dataset.py",
    "shared/storage/artifact_store.py",
    "gateway/services/dataset_service.py"
  ]
}
