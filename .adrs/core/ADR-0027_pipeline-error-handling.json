{
  "schema_type": "adr",
  "id": "ADR-0027_pipeline-error-handling",
  "title": "Multi-Tool Pipeline Error Handling and Recovery Strategy",
  "status": "accepted",
  "date": "2024-12-27",
  "review_date": "2025-06-27",
  "deciders": "Mycahya Eggleston",
  "scope": "core",
  "provenance": [
    {
      "at": "2024-12-27",
      "by": "AI Analysis",
      "note": "Initial draft based on platform Pipeline requirements"
    },
    {
      "at": "2025-12-27",
      "by": "DevTools Editor",
      "note": "Updated via DevTools ADR Editor"
    }
  ],
  "context": "Pipelines orchestrate multi-step workflows across tools (DAT → SOV → PPTX). Each step may fail due to data issues, tool errors, or user cancellation. The system must handle failures gracefully: preserve completed work, provide clear error information, and support recovery. The challenge is balancing fail-fast behavior (stop on first error) with partial results preservation and resume capability.",
  "decision_primary": "Pipeline execution follows fail-fast semantics: if any step fails, subsequent steps are skipped. Partial results from completed steps are preserved as DataSets. Pipelines can be resumed from the last successful step. Each step logs: start_time, end_time, status (pending, running, completed, failed, skipped), and error_message (if failed).",
  "decision_details": {
    "approach": "Sequential step execution with fail-fast. Step outputs saved as DataSets (preserved on failure). Pipeline state tracks step statuses. Resume API reruns failed step and continues.",
    "constraints": [
      "Step failures MUST set pipeline status to 'failed'",
      "Completed step outputs MUST be preserved as DataSets",
      "Subsequent steps MUST be marked 'skipped' on failure",
      "Resume requires explicit user action (not automatic retry)",
      "Each step MUST log start_time, end_time, status, error_message",
      "Error messages MUST be user-friendly (from message catalog)",
      "Timeout per step is configurable (default: 5 minutes)"
    ],
    "implementation_specs": [
      "SPEC-0029_Pipeline-Execution-Spec"
    ]
  },
  "consequences": [
    "Clear error handling prevents silent failures",
    "Partial results preserved (no wasted computation)",
    "Resume capability reduces re-work on transient errors",
    "Fail-fast surfaces errors quickly",
    "Risk: Skipped steps may confuse users (mitigated by clear status UI)",
    "Risk: Resume may use stale context (mitigated by timestamp checks)"
  ],
  "alternatives_considered": [
    {
      "name": "Continue on Error",
      "pros": "Maximizes completed work",
      "cons": "Downstream steps may fail due to missing input",
      "rejected_reason": "Fails dependency model; downstream steps need upstream output"
    },
    {
      "name": "Automatic Retry",
      "pros": "Handles transient errors transparently",
      "cons": "May loop on persistent errors, wastes resources",
      "rejected_reason": "Explicit resume is safer; user controls retry"
    },
    {
      "name": "Rollback on Failure",
      "pros": "Clean state after failure",
      "cons": "Loses completed work, expensive for long pipelines",
      "rejected_reason": "Preserving partial results is more valuable than clean state"
    }
  ],
  "tradeoffs": "We trade automatic recovery for explicit user control. Fail-fast may seem abrupt but surfaces errors quickly. Preserving partial results adds storage but prevents rework.",
  "guardrails": [
    {
      "rule": "Completed step outputs MUST be preserved on pipeline failure",
      "enforcement": "Pipeline service saves step outputs as DataSets before marking failure",
      "scope": "core",
      "id": "pipeline-preserve-partial-results"
    },
    {
      "rule": "Error messages MUST be from message catalog (not hardcoded)",
      "enforcement": "Pipeline service uses message catalog; CI checks for hardcoded strings",
      "scope": "core",
      "id": "pipeline-error-messages-catalog"
    }
  ],
  "cross_cutting_guardrails": [
    "Message Catalogs: All user messages from catalog (see ADR-0045#message-catalogs)",
    "Audit Trail: All step events must be logged (see ADR-0045#audit-trail)"
  ],
  "references": [
    "ADR-0001_Guided-Workflow-FSM-Orchestration: Core FSM pattern for step execution",
    "ADR-0002_Artifact-Preservation-on-Unlock: Partial results preservation",
    "ADR-0004_Deterministic-Content-Addressed-IDs: Step output identification",
    "ADR-0025_DataSet-Lineage-Tracking: Step outputs as DataSets",
    "shared/contracts/core/pipeline.py: Pipeline state schema",
    "gateway/services/pipeline_service.py: Pipeline execution service",
    "ADR-0037",
    "ADR-0045"
  ],
  "tags": [
    "pipeline",
    "error-handling",
    "recovery",
    "fail-fast"
  ],
  "affected_components": [
    "shared/contracts/core/pipeline.py",
    "gateway/services/pipeline_service.py"
  ]
}