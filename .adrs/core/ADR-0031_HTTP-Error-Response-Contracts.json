{
  "schema_type": "adr",
  "id": "ADR-0031",
  "title": "HTTP Error Response Contracts",
  "status": "accepted",
  "date": "2025-12-28",
  "review_date": "2026-06-28",
  "deciders": "CDU-DAT Core Engineering Team",
  "scope": "core",
  "provenance": [
    {
      "at": "2025-12-28",
      "by": "AI Analysis",
      "note": "Initial draft to standardize HTTP error responses across all tools"
    }
  ],
  "context": "The Engineering Tools platform has multiple tools (DAT, SOV, PPTX) that each implement HTTP error handling differently. Some use plain HTTPException with string details, others use partial ErrorResponse contracts. This inconsistency causes:\n\n1. **Frontend parsing complexity**: Different error formats require different handling\n2. **Poor debugging experience**: Missing structured error details, categories, and tool identification\n3. **API contract violations**: API-003 requires 'Error responses MUST use standard error schema'\n4. **Inconsistent error categorization**: No standard categories for validation, not_found, conflict, etc.\n\nThe shared contract `shared/contracts/core/error_response.py` already exists with `ErrorResponse`, `ErrorCategory`, `ErrorDetail`, and `create_error_response()` factory function, but adoption is inconsistent across tools.",
  "decision_primary": "All HTTP error responses across all tools MUST use the `ErrorResponse` contract from `shared/contracts/core/error_response.py`. Each tool MUST implement a standardized error helper module that wraps `create_error_response()` and raises `HTTPException` with the ErrorResponse body. This ensures consistent error format, categorization, and tool identification across the platform.",
  "decision_details": {
    "approach": "Centralized error contract with tool-specific helper modules",
    "error_response_schema": {
      "required_fields": [
        "status_code: int - HTTP status code (400, 404, 500, etc.)",
        "category: ErrorCategory - Error classification enum",
        "message: str - Human-readable error message",
        "timestamp: datetime - When error occurred (ISO-8601 UTC)"
      ],
      "optional_fields": [
        "details: list[ErrorDetail] - Field-specific error details",
        "tool: str - Tool name (dat, sov, pptx, gateway)",
        "request_id: str - Request ID for tracing",
        "severity: ErrorSeverity - error, warning, info"
      ]
    },
    "error_categories": {
      "validation": "400 - Request validation failures, invalid input",
      "not_found": "404 - Resource does not exist",
      "conflict": "409 - Resource state conflict (already exists, locked)",
      "permission": "403 - Insufficient permissions",
      "rate_limit": "429 - Too many requests",
      "internal": "500 - Unexpected server errors",
      "dependency": "502/503 - External service failures",
      "timeout": "504 - Request timeout",
      "cancelled": "499 - Client cancelled request"
    },
    "implementation_pattern": {
      "tool_helper_module": "Each tool creates an errors.py module with helper functions",
      "helper_functions": [
        "raise_error(status_code, message, category, field, details) - General error",
        "raise_not_found(resource_type, resource_id) - 404 errors",
        "raise_validation_error(message, field) - 400 validation errors",
        "raise_internal_error(message, exception) - 500 errors",
        "raise_conflict_error(message) - 409 conflict errors"
      ],
      "example_usage": "raise_not_found('Project', str(project_id))"
    },
    "constraints": [
      "All HTTP 4xx/5xx responses MUST use ErrorResponse schema",
      "Tool name MUST be included in all error responses",
      "Validation errors MUST include field name when applicable",
      "Internal errors SHOULD include exception type in details",
      "Error messages MUST be user-friendly (from message catalog when available)",
      "HTTPException detail MUST be ErrorResponse.model_dump(mode='json')",
      "Never return plain string details in HTTPException"
    ],
    "implementation_specs": [
      "SPEC-0035_Error-Response-Implementation-Guide"
    ]
  },
  "consequences": [
    "✅ POSITIVE: Consistent error format across all tools and endpoints",
    "✅ POSITIVE: Frontend can use single error parsing logic",
    "✅ POSITIVE: Structured error details enable better debugging",
    "✅ POSITIVE: Tool identification helps trace errors in multi-tool pipelines",
    "✅ POSITIVE: Error categories enable programmatic error handling",
    "✅ POSITIVE: Complies with API-003 acceptance criterion",
    "❌ NEGATIVE: Requires updating all existing error handling code",
    "❌ NEGATIVE: Slightly more verbose than plain HTTPException",
    "⚠️ NEUTRAL: Additional import required in each API module"
  ],
  "alternatives_considered": [
    {
      "name": "Plain HTTPException with string detail",
      "pros": "Simple, minimal code, FastAPI default",
      "cons": "No structure, no categorization, no tool identification, inconsistent format",
      "rejected_reason": "Does not meet API-003 requirement for standard error schema"
    },
    {
      "name": "FastAPI exception handlers only",
      "pros": "Centralized error handling, less code in endpoints",
      "cons": "Loses context about error source, harder to customize per-endpoint",
      "rejected_reason": "Error context is important for debugging and user feedback"
    },
    {
      "name": "Custom exception classes per error type",
      "pros": "Type-safe, Python-native pattern",
      "cons": "Many classes to maintain, still need to convert to response format",
      "rejected_reason": "ErrorCategory enum provides same classification without class explosion"
    }
  ],
  "tradeoffs": "We trade simplicity for consistency and debuggability. The helper functions minimize verbosity while ensuring all errors include required context. The small overhead of importing the helper module is justified by the benefits of standardized error responses.",
  "rollout_plan": [
    "1. Verify ErrorResponse contract in shared/contracts/core/error_response.py",
    "2. Create errors.py helper module for each tool (PPTX done as reference)",
    "3. Update all API endpoints to use helper functions instead of plain HTTPException",
    "4. Update global exception handlers to use ErrorResponse",
    "5. Add integration tests for error response format",
    "6. Update frontend error handling to use new format",
    "7. Document error categories and codes in API documentation"
  ],
  "rollback_plan": "If standardized errors cause issues: (1) Revert to plain HTTPException, (2) Remove errors.py helper modules, (3) Keep ErrorResponse contract for future use. Low risk since changes are additive.",
  "metrics_to_watch": [
    "Number of error responses with missing tool field (should be 0)",
    "Error parsing failures in frontend (should decrease)",
    "Developer questions about error format (should decrease)",
    "Time to debug production errors (should decrease)"
  ],
  "guardrails": [
    {
      "id": "http-error-response-contract",
      "rule": "All HTTP 4xx/5xx responses MUST use ErrorResponse schema from shared/contracts/core/error_response.py",
      "enforcement": "Code review; linting rule to detect plain HTTPException with string detail",
      "scope": "core"
    },
    {
      "id": "http-error-tool-identification",
      "rule": "All error responses MUST include the tool name (dat, sov, pptx, gateway)",
      "enforcement": "Integration tests verify tool field is present",
      "scope": "core"
    },
    {
      "id": "http-error-validation-field",
      "rule": "Validation errors (400) SHOULD include field name in details when applicable",
      "enforcement": "Code review; API documentation review",
      "scope": "core"
    }
  ],
  "cross_cutting_guardrails": [
    "ADR-0017#message-catalogs: Error messages should use message catalog when available",
    "ADR-0009#type-safety: ErrorResponse is a Pydantic model ensuring type safety"
  ],
  "references": [
    "shared/contracts/core/error_response.py: ErrorResponse, ErrorCategory, ErrorDetail, create_error_response",
    "ADR-0009_Type-Safety-Contract-Discipline: Pydantic-first contracts",
    "ADR-0017_Cross-Cutting-Guardrails: Message catalog requirement",
    "API-003: Error responses MUST use standard error schema",
    "RFC 7807: Problem Details for HTTP APIs (inspiration)"
  ],
  "tags": [
    "api",
    "error-handling",
    "contracts",
    "http",
    "standardization"
  ],
  "affected_components": [
    "shared/contracts/core/error_response.py",
    "apps/pptx_generator/backend/api/errors.py",
    "apps/pptx_generator/backend/api/*.py",
    "apps/data_aggregator/backend/src/dat_aggregation/api/routes.py",
    "apps/sov_analyzer/backend/src/sov_analyzer/api/routes.py",
    "gateway/main.py",
    "gateway/services/*.py"
  ]
}
