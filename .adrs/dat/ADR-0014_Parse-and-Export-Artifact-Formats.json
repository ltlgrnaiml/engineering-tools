{
  "schema_type": "adr",
  "id": "ADR-0014_Parse-and-Export-Artifact-Formats",
  "title": "Parse and Export Artifact Formats: Parquet for Parse, Multi-Format Export, and Metadata Bundling",
  "status": "accepted",
  "date": "2025-11-24",
  "deciders": "Mycahya Eggleston",
  "scope": "subsystem:DAT",
  "provenance": [
    {
      "at": "2025-11-24",
      "by": "Mycahya Eggleston",
      "note": "Initial draft and acceptance of artifact format policy for DAT."
    }
  ],
  "context": "DAT must support deterministic, scalable, and audit-ready data processing for semiconductor manufacturing analytics. The pipeline produces multi-artifact bundles at each stage, with distinct requirements for data and metadata formats. Parquet is the standard for data tables (columnar, efficient, reproducible) while JSON/YAML is used for metadata (human-readable, auditable). Users need efficient storage for parsed data, but also flexibility in export formats to support diverse downstream workflows. Metadata artifacts (manifest, prep report, transform plan, roles mapping) must be human-readable and support audit, provenance, and semantic mapping. The export stage must allow users to select output formats for data tables, while metadata remains standardized.",
  "decision_primary": "DAT will enforce Parquet format for all main data tables produced during the Parse stage, using Polars/Arrow as the canonical in-memory representation and I/O substrate. All metadata, provenance, and semantic mapping artifacts (manifest, prep report, transform plan, roles mapping) will be saved in JSON or YAML formats as appropriate. During the Export stage, users may select the output format for data tables (Parquet, CSV, TSV, JSON, etc.) at runtime, but metadata artifacts will remain in their canonical JSON/YAML formats.",
  "decision_details": {
    "approach": "Parse stage artifacts are saved as a multi-artifact bundle: dataset.parquet (main data table), manifest.json (provenance, audit trail), prep_report.json (validation summary), transform_plan.json (ordered steps, metadata), and roles.yaml (semantic mapping). Export stage provides user-selectable output formats for data tables, implemented via runtime handlers. Metadata artifacts are always saved in JSON/YAML for consistency and auditability.",
    "implementation_specs": [
      "SPEC-0013_Artifact-Lifecycle-Preservation-Spec",
      "SPEC-0004_Profile-Driven-Extraction",
      "SPEC-0012_Audit-Trail-Enforcement-Spec",
      "SPEC-0016_Path-Safety-And-Normalization-Spec"
    ],
    "constraints": [
      "All parse-stage data tables must be saved as Parquet.",
      "All metadata artifacts must be saved as JSON or YAML.",
      "Export-stage data tables must support user-selectable formats.",
      "Metadata artifacts must remain in canonical formats regardless of export data format."
    ]
  },
  "consequences": [
    "Parse artifacts are always deterministic, scalable, and audit-ready.",
    "Metadata is human-readable and easy to audit.",
    "Users can export data in the format that best fits their workflow.",
    "Audit trail and provenance are preserved in Parquet and manifest files.",
    "Requires robust export logic to handle multiple formats.",
    "Slight increase in code complexity for export stage."
  ],
  "alternatives_considered": [
    {
      "name": "Enforce Parquet for Export",
      "pros": "Simplicity, consistency.",
      "cons": "Limits user flexibility, may not fit all use cases.",
      "rejected_reason": "Not user-centric; rejected for export stage."
    },
    {
      "name": "Allow CSV/TSV/JSON for Parse",
      "pros": "Human-readable, simple.",
      "cons": "Not scalable, poor for large datasets, no schema.",
      "rejected_reason": "Not robust for semiconductor data; rejected for parse stage."
    },
    {
      "name": "User-selectable format for both stages",
      "pros": "Maximum flexibility.",
      "cons": "Risk of fragmentation, loss of determinism/auditability.",
      "rejected_reason": "Rejected for parse; accepted for export."
    }
  ],
  "tradeoffs": "We trade strict consistency and determinism in parse artifacts for user flexibility in export. We accept increased export logic complexity to maximize user satisfaction and downstream compatibility.",
  "rollout_plan": [
    "Update pipeline logic to enforce Parquet for all parse outputs.",
    "Implement export handlers for Parquet, CSV, TSV, JSON.",
    "Update documentation/specs to clearly state format policy.",
    "Update UI/CLI to allow users to select export format at runtime.",
    "Add tests for all supported export formats.",
    "Document rationale and workflow in onboarding materials."
  ],
  "rollback_plan": "Revert to previous logic enforcing a single format for both parse and export stages; remove user-selectable export formats.",
  "metrics_to_watch": [
    "Incidents of export failures due to format selection.",
    "User feedback on export format flexibility.",
    "Audit trail completeness for all artifact bundles.",
    "CI test coverage for all supported formats."
  ],
  "guardrails": [
    {
      "rule": "All parse-stage data tables MUST be saved as Parquet.",
      "enforcement": "Backend enforces Parquet output for parse; CI tests validate artifact formats.",
      "scope": "subsystem:DAT"
    },
    {
      "rule": "All metadata artifacts MUST be saved as JSON or YAML.",
      "enforcement": "Backend enforces format; CI tests validate artifact formats.",
      "scope": "subsystem:DAT"
    },
    {
      "rule": "Export-stage data tables MUST support user-selectable formats.",
      "enforcement": "UI/CLI provides format selection; backend implements runtime handlers.",
      "scope": "subsystem:DAT"
    }
  ],
  "cross_cutting_guardrails": [
    "Path Safety: All public paths must be relative (see ADR-0017#path-safety)",
    "Deterministic Artifacts: All outputs must be reproducible given the same inputs (see ADR-0017_Cross-Cutting-Guardrails#deterministic-artifacts)",
    "Audit Trail: All lifecycle events must be logged (see ADR-0017_Cross-Cutting-Guardrails#audit-trail)"
  ],
  "references": [
    "ADR-0001_Guided-Workflow-FSM-Orchestration: Core FSM pattern",
    "ADR-0002_Artifact-Preservation-on-Unlock: Artifact preservation policy",
    "ADR-0004_Deterministic-Stage-IDs: Deterministic artifact identification",
    "ADR-0008_Audit-Trail-Timestamps: Timestamp formats",
    "ADR-0011_Profile-Driven-Extraction-and-Adapters: Profile-based extraction",
    "ADR-0013_Cancellation-Semantics-Parse-Export: Cancellation handling"
  ],
  "tags": [
    "parquet",
    "csv",
    "json",
    "yaml",
    "artifact-bundle",
    "export",
    "determinism",
    "audit-trail"
  ],
  "affected_components": [
    "backend/src/cdu_dat/parse.py",
    "backend/src/cdu_dat/export.py",
    "backend/src/cdu_dat/artifact_writer.py",
    "frontend/src/components/ExportPanel.tsx"
  ],
  "review_date": "2026-05-24"
}
