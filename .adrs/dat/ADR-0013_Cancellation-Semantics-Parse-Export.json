{
  "schema_type": "adr",
  "id": "ADR-0013_Cancellation-Semantics-Parse-Export",
  "title": "Cancellation Semantics for Parse & Export: Artifact Preservation, Audit Trail, and Explicit Cleanup",
  "status": "accepted",
  "date": "2025-11-24",
  "deciders": "Mycahya Eggleston",
  "scope": "subsystem:DAT",
  "provenance": [
    {
      "at": "2025-11-22",
      "by": "Mycahya Eggleston",
      "note": "Initial draft capturing soft-cancel, artifact preservation, and explicit cleanup."
    },
    {
      "at": "2025-11-24",
      "by": "Mycahya Eggleston",
      "note": "Patched to add checkpointing guarantees for Parse/Export (no partial tables/rows/values) and aligned implementation_specs to SPEC-00xx files."
    },
    {
      "at": "2025-12-27",
      "by": "DevTools Editor",
      "note": "Updated via DevTools ADR Editor"
    }
  ],
  "context": "Long-running jobs in Parse and Export stages require clear cancellation semantics to balance user expectations, artifact preservation, operational safety, and data integrity. Users expect to be able to cancel jobs without losing valuable work, while the system must maintain a consistent state, provide full auditability, and avoid persisting incomplete or corrupt data. Automatic deletion risks accidental data loss and undermines user confidence. Explicit, user-initiated cleanup and robust observability are required. Additionally, cancellation must be checkpointed so that no partial tables, rows, or values are persistedâ€”only fully completed artifacts are retained.",
  "decision_primary": "Cancellation always preserves fully completed artifacts and sets job state to 'cancelled'. No artifacts are deleted by default. Cleanup is explicit and user-initiated. All cancellation events are fully auditable and visible in logs/status. For Parse and Export stages, cancellation is checkpointed such that no partial tables, rows, or values are persisted; any in-progress or incomplete data is rolled back or discarded. Minimal explicit cleanup may be performed to ensure consistency and prevent partial data artifacts.",
  "decision_details": {
    "approach": "Implement soft cancellation with deterministic checkpointing for Parse/Export: write-through is allowed only for fully completed tables/rows; partial work is rolled back or discarded. Preserve completed artifacts; require explicit user-initiated cleanup for temporary files/buffers. Enforce observability: log all cancellation and cleanup operations with ISO-8601 UTC timestamps (no microseconds).",
    "implementation_specs": [
      "SPEC-0015_Cancellation-Cleanup-Spec",
      "SPEC-0013_Artifact-Lifecycle-Preservation-Spec",
      "SPEC-0012_Audit-Trail-Enforcement-Spec"
    ],
    "constraints": [
      "Cancel operation must never delete completed artifacts by default.",
      "No partial tables, rows, or values may be persisted after cancellation.",
      "Cleanup (deletion) must be explicit and user-initiated.",
      "All cancellation events must be logged and auditable.",
      "System state must remain consistent after cancellation.",
      "Checkpointing must be deterministic and reproducible across machines."
    ]
  },
  "consequences": [
    "Users can cancel jobs without fear of losing completed work.",
    "Partial artifacts (incomplete tables/rows/values) are never persisted, ensuring data integrity.",
    "Cleanup is controlled and safe, reducing risk of accidental data loss.",
    "Audit trail and observability support compliance and debugging.",
    "Disk usage may grow due to preserved completed artifacts and temporary files; requires manual or future cleanup."
  ],
  "alternatives_considered": [
    {
      "name": "Cancel Deletes All Artifacts",
      "pros": "Simplifies disk management.",
      "cons": "Risks accidental data loss, poor user experience.",
      "rejected_reason": "Unacceptable risk to user work and confidence."
    },
    {
      "name": "Cancel Pauses/Resumes",
      "pros": "Allows job recovery.",
      "cons": "Complex state management, not always feasible.",
      "rejected_reason": "Adds unnecessary complexity for most workflows."
    },
    {
      "name": "Allow Partial Artifacts on Cancel",
      "pros": "May allow inspection of intermediate results.",
      "cons": "Risks data integrity, downstream errors, and user confusion.",
      "rejected_reason": "Fails integrity and determinism goals."
    }
  ],
  "tradeoffs": "We trade increased disk usage and occasional manual cleanup for stronger user confidence, auditability, determinism, and data integrity. Explicit cleanup replaces risky automatic deletion.",
  "rollout_plan": [
    "Update Parse and Export stages to implement soft cancellation with deterministic checkpointing.",
    "Ensure only fully completed tables/rows/values can be persisted post-cancel; roll back or discard partial work.",
    "Add explicit cleanup APIs and UI controls for temporary artifacts.",
    "Enhance audit trail and logging for cancellation and cleanup actions (UTC, no microseconds).",
    "Train contributors and users on new cancellation semantics and cleanup flow."
  ],
  "rollback_plan": "Revert to prior cancellation logic and remove checkpointing guarantees (not recommended due to integrity risks).",
  "metrics_to_watch": [
    "Incidents of accidental data loss after cancellation.",
    "Incidents of partial/incomplete data artifacts after cancellation.",
    "Audit trail completeness for cancellation events.",
    "User feedback on cancellation behavior and recovery."
  ],
  "guardrails": [
    {
      "rule": "Cancel operation must never delete completed artifacts by default.",
      "enforcement": "Backend preserves completed artifacts; cleanup requires explicit user action via API/UI.",
      "scope": "subsystem:DAT"
    },
    {
      "rule": "No partial tables, rows, or values may be persisted after cancellation.",
      "enforcement": "Write-through is conditioned on completion; CI tests simulate mid-stream cancellation and assert zero partial data.",
      "scope": "subsystem:DAT"
    },
    {
      "rule": "All cancellation and cleanup events must be logged and auditable.",
      "enforcement": "Orchestrator writes ISO-8601 UTC timestamps for cancel/cleanup; CI contract checks enforce presence/format.",
      "scope": "subsystem:DAT"
    }
  ],
  "cross_cutting_guardrails": [
    "Artifact Preservation: All unlocks and cancels must preserve artifacts (see ADR-0017_Cross-Cutting-Guardrails#artifact-preservation)",
    "Audit Trail: All lifecycle events must be logged (see ADR-0017_Cross-Cutting-Guardrails#audit-trail)",
    "Deterministic Artifacts: Outputs must be reproducible; no partial data persisted (see ADR-0017_Cross-Cutting-Guardrails#deterministic-artifacts)"
  ],
  "references": [
    "ADR-0001_Guided-Workflow-FSM-Orchestration: Core FSM pattern",
    "ADR-0002_Artifact-Preservation-on-Unlock: Artifact preservation on cancellation",
    "ADR-0004_Deterministic-Stage-IDs: Deterministic artifact identification",
    "ADR-0017_Cross-Cutting-Guardrails"
  ],
  "tags": [
    "cancellation",
    "artifact-preservation",
    "audit-trail",
    "explicit-cleanup",
    "checkpointing",
    "data-integrity"
  ],
  "affected_components": [
    "parse stage",
    "export stage",
    "audit trail",
    "cleanup logic",
    "user interface"
  ],
  "review_date": "2026-05-22"
}
