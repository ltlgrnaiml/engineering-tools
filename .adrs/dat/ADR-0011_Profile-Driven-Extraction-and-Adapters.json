{
  "schema_type": "adr",
  "id": "ADR-0011_Profile-Driven-Extraction-and-Adapters",
  "title": "Profile-Driven Extraction & AdapterFactory Pattern for Extensible, Deterministic Data Extraction",
  "status": "accepted",
  "date": "2025-11-22",
  "deciders": "Mycahya Eggleston",
  "scope": "subsystem:DAT",
  "provenance": [
    {
      "at": "2025-11-22",
      "by": "Mycahya Eggleston",
      "note": "Initial draft"
    },
    {
      "at": "2025-12-27",
      "by": "DevTools Editor",
      "note": "Updated via DevTools ADR Editor"
    },
    {
      "at": "2025-12-28",
      "by": "Mycahya Eggleston",
      "note": "Added concrete adapter interface contract reference (shared/contracts/dat/adapter.py)"
    }
  ],
  "context": "Supporting extensible, deterministic, and user-customizable data extraction across multiple formats is critical for operational excellence and auditability. Hardcoded extraction logic and ad-hoc scripts lead to code drift, poor provenance, and limited extensibility. A profile-driven approach, with versioned profiles as the single source of truth and an AdapterFactory pattern for format extensibility, ensures that extraction logic is governed, reproducible, and easily extended. Context mapping, stable column policies, and diagnostic messaging must be profile-driven and standardized.",
  "decision_primary": "All data extraction and context mapping are governed by versioned, provenance-tracked profiles (system/user). Adapters are selected via an AdapterFactory pattern, supporting multi-format extensibility. Extraction is deterministic, path-safe, and honors stable column subset/warn policies. Diagnostic messages are catalog-driven. No bulk data is returned to FE. All provenance (hashes, timestamps, seed) is recorded per ADR-0008.",
  "decision_details": {
    "approach": "Profiles are the single source of truth for extraction logic, context mapping, and normalization. AdapterFactory selects the appropriate adapter based on profile format handle. Adapters enforce deterministic traversal, path safety, and stable column projection. Diagnostic messages are standardized via a catalog. Provenance and determinism are enforced via content hashes, ISO-8601 UTC timestamps, and seed logging.",
    "constraints": [
      "All extraction logic must be defined in versioned profiles.",
      "AdapterFactory must support multi-format extensibility (handles-first).",
      "Adapters must enforce path safety, deterministic traversal, and stable column policies.",
      "Diagnostic messages must be catalog-driven.",
      "No bulk data is returned to FE; row/limit policies are enforced.",
      "Provenance (hashes, timestamps, seed) must be recorded per ADR-0008."
    ],
    "implementation_specs": [
      "SPEC-DAT-0003_Adapter-Interface-Registry",
      "SPEC-DAT-0005_Profile-File-Management",
      "SPEC-0015_Cancellation-Cleanup-Spec",
      "SPEC-0002_Profile-Context-Orchestration",
      "SPEC-0007_Stable-Columns-Policy-Spec",
      "SPEC-0016_Path-Safety-And-Normalization-Spec",
      "SPEC-0005_Message-Catalog-Spec",
      "SPEC-0011_Profile-Driven-Extraction"
    ],
    "tier_0_contracts": [
      "shared.contracts.dat.adapter.BaseFileAdapter",
      "shared.contracts.dat.adapter.AdapterMetadata",
      "shared.contracts.dat.adapter.AdapterCapabilities",
      "shared.contracts.dat.adapter.SchemaProbeResult",
      "shared.contracts.dat.adapter.ReadOptions",
      "shared.contracts.dat.adapter.StreamOptions",
      "shared.contracts.dat.profile.ExtractionProfile"
    ],
    "builtin_adapters": [
      {"adapter_id": "csv", "file_extensions": [".csv", ".tsv"], "status": "planned"},
      {"adapter_id": "excel", "file_extensions": [".xlsx", ".xls"], "status": "planned"},
      {"adapter_id": "json", "file_extensions": [".json", ".jsonl", ".ndjson"], "status": "planned"},
      {"adapter_id": "sql", "file_extensions": [], "status": "future"}
    ]
  },
  "consequences": [
    "Extraction logic is extensible, deterministic, and auditable.",
    "Adapters can be extended to new formats without core code changes.",
    "Stable column policies and diagnostics are standardized.",
    "Some up-front discipline required for profile/schema governance.",
    "Legacy code may require refactoring to align with profile-driven approach."
  ],
  "alternatives_considered": [
    {
      "name": "Hardcoded Extraction Logic",
      "pros": "Simple for initial implementation.",
      "cons": "Poor extensibility, provenance, and auditability.",
      "rejected_reason": "Fails operational excellence and maintainability goals."
    },
    {
      "name": "Ad-hoc Per-Format Scripts",
      "pros": "Flexible for quick fixes.",
      "cons": "Leads to code drift and inconsistent behavior.",
      "rejected_reason": "Not sustainable for multi-format, multi-user environments."
    },
    {
      "name": "Hybrid Profile + Manual Overrides",
      "pros": "Maximum flexibility.",
      "cons": "Risks breaking determinism and provenance.",
      "rejected_reason": "Incompatible with audit and reproducibility requirements."
    }
  ],
  "tradeoffs": "Requires discipline in profile/schema governance and diagnostic catalog management, but delivers extensibility, auditability, and operational excellence.",
  "rollout_plan": [
    "Audit all existing extraction logic and migrate to profile-driven approach.",
    "Implement AdapterFactory with multi-format registry.",
    "Standardize stable column policy and diagnostics via catalog.",
    "Refactor legacy code to align with new profiles and adapters.",
    "Train contributors on profile-driven workflow."
  ],
  "rollback_plan": "Revert to previous hardcoded or ad-hoc extraction logic (not recommended).",
  "metrics_to_watch": [
    "Percentage of extraction logic governed by profiles.",
    "Number of supported formats in AdapterFactory registry.",
    "Incidents of non-deterministic or path-unsafe extraction.",
    "Diagnostic message coverage in catalog."
  ],
  "guardrails": [
    {
      "rule": "All extraction logic must be profile-driven and adapters must be selected via handles-first registry.",
      "enforcement": "CI blocks merges if extraction logic is not governed by profiles or adapters are not registry-selected.",
      "scope": "core"
    }
  ],
  "cross_cutting_guardrails": [
    "Path Safety: All file paths must be relative (see ADR-0017#path-safety)",
    "Deterministic Artifacts: All outputs must be reproducible given the same inputs (see ADR-0017_Cross-Cutting-Guardrails#deterministic-artifacts)",
    "No Bulk Data: Adapters must not return bulk data to FE (see ADR-0017_Cross-Cutting-Guardrails#no-bulk-data)"
  ],
  "references": [
    "ADR-0001_Guided-Workflow-FSM-Orchestration: Core FSM pattern for stage transitions",
    "ADR-0009_Type-Safety-Contract-Discipline: Profile schemas as Pydantic contracts",
    "ADR-0017_Cross-Cutting-Guardrails: Platform-wide guardrails"
  ],
  "tags": [
    "profile-driven",
    "adapter-factory",
    "determinism",
    "extensibility",
    "path-safety"
  ],
  "affected_components": [
    "shared/contracts/dat/adapter.py",
    "shared/contracts/dat/profile.py",
    "apps/data_aggregator/backend/adapters/registry.py",
    "apps/data_aggregator/backend/adapters/csv_adapter.py",
    "apps/data_aggregator/backend/adapters/excel_adapter.py",
    "apps/data_aggregator/backend/adapters/json_adapter.py",
    "apps/data_aggregator/config/profiles/"
  ],
  "review_date": "2026-05-22"
}
