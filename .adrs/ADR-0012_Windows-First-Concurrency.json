{
  "schema_type": "adr",
  "id": "ADR-0012_Windows-First-Concurrency",
  "title": "Windows-First Concurrency: Reliable, Deterministic, and Cross-Platform Parallelism",
  "status": "proposed",
  "date": "2025-11-22",
  "deciders": "CDU-DAT Core Engineering Team",
  "scope": "core",
  "provenance": [
    {
      "at": "2025-11-22",
      "by": "Mycahya Eggleston",
      "note": "Initial draft"
    }
  ],
  "context": "Concurrency in data pipelines and analysis tools must be reliable, deterministic, and fully cross-platform, with special attention to Windows compatibility. Raw multiprocessing/threading approaches are error-prone and often fail on Windows due to differences in process spawning and resource management. Deterministic seeding and fixed thread caps are required for reproducibility and CI stability. This ADR references legacy Windows concurrency ADRs.",
  "decision_primary": "All parallelism must use a spawn-safe API (no raw multiprocessing/threading). Fixed thread caps and deterministic seeding are enforced. CI and test coverage must include Windows as a first-class platform.",
  "decision_details": {
    "approach": "Adopt or build a concurrency abstraction that is spawn-safe and cross-platform. All parallel code must use this API. Thread/process caps and deterministic random seeds are enforced globally. CI runs all concurrency tests on Windows and Linux.",
    "constraints": [
      "No use of raw multiprocessing or threading modules.",
      "All concurrency must be spawn-safe and cross-platform.",
      "Thread/process caps must be configurable and enforced.",
      "Deterministic seeding is required for all parallel operations.",
      "CI must run all concurrency tests on Windows."
    ],
    "implementation_specs": [
      "SPEC-0011_Concurrency-Determinism-Spec"
    ]
  },
  "consequences": [
    "Concurrency is reliable and deterministic across all supported platforms.",
    "Windows is a first-class citizen for development and CI.",
    "Slightly higher up-front effort to build or adopt spawn-safe abstractions.",
    "Legacy code using raw multiprocessing/threading may require refactoring."
  ],
  "alternatives_considered": [
    {
      "name": "Raw Multiprocessing/Threading",
      "pros": "Familiar to many developers, minimal abstraction.",
      "cons": "Not cross-platform, error-prone on Windows, hard to enforce determinism.",
      "rejected_reason": "Fails reliability and cross-platform goals."
    },
    {
      "name": "Linux-Only Concurrency",
      "pros": "Simpler CI, fewer platform-specific bugs.",
      "cons": "Excludes Windows users and developers.",
      "rejected_reason": "Not acceptable for a cross-platform project."
    }
  ],
  "tradeoffs": "Requires discipline and up-front investment in spawn-safe abstractions and CI, but ensures reliability and reproducibility for all users. Some legacy code refactoring may be needed.",
  "rollout_plan": [
    "Audit all existing concurrency usage and refactor to spawn-safe API.",
    "Implement deterministic seeding and thread/process caps.",
    "Expand CI to include Windows concurrency tests.",
    "Document new concurrency standards and train contributors."
  ],
  "rollback_plan": "Revert to previous concurrency approach (not recommended).",
  "metrics_to_watch": [
    "CI pass rate for Windows concurrency tests.",
    "Incidents of non-deterministic or platform-specific concurrency bugs.",
    "Percentage of code using spawn-safe concurrency API."
  ],
  "guardrails": [
    {
      "rule": "All concurrency must be spawn-safe and cross-platform.",
      "enforcement": "CI blocks merges if raw multiprocessing/threading is detected or if Windows tests fail.",
      "scope": "core",
      "id": "concurrency-spawn-safe-cross-platform"
    }
  ],
  "cross_cutting_guardrails": [
    "Deterministic Artifacts: All parallel operations must be reproducible (see .adrs/cross-cutting/GUARDRAILS.md#deterministic-artifacts)"
  ],
  "references": [
    "Legacy Windows concurrency Concepts",
    ".adrs/cross-cutting/GUARDRAILS.md"
  ],
  "tags": [
    "concurrency",
    "windows",
    "determinism",
    "cross-platform"
  ],
  "affected_components": [
    "concurrency abstractions",
    "ci pipeline",
    "developer workflow"
  ],
  "review_date": "2026-05-22"
}
