{
  "schema_type": "spec",
  "id": "SPEC-0011_output-target-adapters",
  "title": "Output Target Adapters Specification",
  "version": "0.1.0",
  "status": "draft",
  "date": "2025-12-27",
  "author": "Mycahya Eggleston",
  "implements_adr": [
    "ADR-0028_Unified-Rendering-Engine"
  ],
  "tier_0_contracts": [
    {
      "module": "shared.contracts.core.rendering",
      "classes": [
        "OutputTarget",
        "OutputFormat",
        "RenderedOutput"
      ]
    }
  ],
  "purpose": "Define the output adapter layer that converts engine-generated content to target-specific formats. Adapters enable the same RenderSpec to produce outputs for web preview, static images, PDFs, and PowerPoint slides.",
  "scope": "core",
  "requirements": [
    {
      "id": "REQ-ADAPT-001",
      "description": "Each OutputTarget MUST have a corresponding adapter",
      "targets": [
        "WEB_JSON",
        "WEB_HTML",
        "PNG",
        "SVG",
        "PDF",
        "PPTX_IMAGE",
        "PPTX_NATIVE"
      ]
    },
    {
      "id": "REQ-ADAPT-002",
      "description": "Adapters MUST implement common BaseAdapter interface",
      "interface": "adapt(raw_output: bytes | dict, format: OutputFormat) -> RenderedOutput"
    },
    {
      "id": "REQ-ADAPT-003",
      "description": "Web adapters MUST return JSON compatible with frontend charting libraries",
      "libraries": [
        "Recharts",
        "Chart.js",
        "Plotly.js"
      ]
    },
    {
      "id": "REQ-ADAPT-004",
      "description": "Image adapters MUST support configurable DPI and dimensions",
      "defaults": {
        "width_px": 800,
        "height_px": 600,
        "dpi": 150
      }
    },
    {
      "id": "REQ-ADAPT-005",
      "description": "PPTX adapters MUST return format consumable by python-pptx",
      "formats": [
        "BytesIO (for images)",
        "dict (for native charts)"
      ]
    }
  ],
  "adapters": {
    "web_json_adapter": {
      "module": "shared.rendering.adapters.web_json",
      "output_target": "WEB_JSON",
      "output_type": "JSON string",
      "use_cases": [
        "Frontend chart rendering",
        "API responses"
      ],
      "schema": {
        "chart": {
          "type": "string",
          "series": "array",
          "categories": "array",
          "style": "object"
        },
        "table": {
          "headers": "array",
          "rows": "array",
          "styles": "object"
        }
      }
    },
    "web_html_adapter": {
      "module": "shared.rendering.adapters.web_html",
      "output_target": "WEB_HTML",
      "output_type": "HTML string with embedded JS",
      "use_cases": [
        "Interactive charts",
        "Standalone HTML exports"
      ],
      "dependencies": [
        "Plotly.js embedded"
      ]
    },
    "png_adapter": {
      "module": "shared.rendering.adapters.png",
      "output_target": "PNG",
      "output_type": "PNG image bytes",
      "use_cases": [
        "Static exports",
        "Email attachments",
        "PPTX embedding"
      ],
      "options": [
        "dpi",
        "width_px",
        "height_px",
        "transparent_background"
      ]
    },
    "svg_adapter": {
      "module": "shared.rendering.adapters.svg",
      "output_target": "SVG",
      "output_type": "SVG XML string",
      "use_cases": [
        "Vector exports",
        "Web embedding",
        "Print-quality output"
      ]
    },
    "pdf_adapter": {
      "module": "shared.rendering.adapters.pdf",
      "output_target": "PDF",
      "output_type": "PDF bytes",
      "use_cases": [
        "Document exports",
        "Report generation"
      ],
      "dependencies": [
        "matplotlib PDF backend"
      ]
    },
    "pptx_image_adapter": {
      "module": "shared.rendering.adapters.pptx_image",
      "output_target": "PPTX_IMAGE",
      "output_type": "BytesIO PNG for PPTX insertion",
      "use_cases": [
        "Chart shapes in PowerPoint"
      ],
      "notes": "Uses PNG adapter internally, returns BytesIO for python-pptx"
    },
    "pptx_native_adapter": {
      "module": "shared.rendering.adapters.pptx_native",
      "output_target": "PPTX_NATIVE",
      "output_type": "dict for python-pptx chart/table APIs",
      "use_cases": [
        "Native PowerPoint charts that remain editable"
      ],
      "limitations": "Not all chart types supported by python-pptx"
    }
  },
  "adapter_interface": {
    "base_class": "BaseAdapter",
    "methods": [
      {
        "name": "adapt",
        "signature": "def adapt(self, raw_output: Any, format: OutputFormat) -> RenderedOutput",
        "description": "Convert raw engine output to target-specific format"
      },
      {
        "name": "supports",
        "signature": "def supports(self, spec_type: type[RenderSpec]) -> bool",
        "description": "Check if adapter supports given spec type"
      }
    ],
    "registry": {
      "pattern": "Factory pattern with target-based lookup",
      "function": "get_adapter(target: OutputTarget) -> BaseAdapter"
    }
  },
  "fallback_behavior": {
    "description": "If requested adapter fails, fall back to PNG",
    "fallback_chain": [
      "PPTX_NATIVE → PPTX_IMAGE → PNG",
      "WEB_HTML → WEB_JSON"
    ],
    "always_available": "PNG"
  },
  "examples": {
    "chart_to_png": {
      "input": "ChartSpec(chart_type=LINE, series=[...])",
      "adapter": "PNGAdapter",
      "output": "RenderedOutput(target=PNG, output_data=<base64>, mime_type='image/png')"
    },
    "table_to_web": {
      "input": "TableSpec(data=TableData(headers=[...], rows=[...]))",
      "adapter": "WebJSONAdapter",
      "output": "RenderedOutput(target=WEB_JSON, output_data='{\"headers\": [...], \"rows\": [...]}')"
    }
  },
  "references": [
    "ADR-0028_Unified-Rendering-Engine: WHY we need unified rendering",
    "SPEC-0031_Unified-Rendering-Contracts: WHAT contracts are used",
    "SPEC-0032_Rendering-Engine-Architecture: HOW the engine processes specs"
  ]
}