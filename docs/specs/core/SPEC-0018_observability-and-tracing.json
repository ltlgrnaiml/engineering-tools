{
  "schema_type": "spec",
  "id": "SPEC-0018_observability-and-tracing",
  "title": "Observability and Tracing Specification (Backend + Frontend)",
  "version": "2025.12.002",
  "status": "active",
  "implements": "ADR-0037",
  "date": "2025-12-28",
  "scope": "core",
  "summary": "Technical specification for unified observability across backend (structured JSON logging, request ID propagation, FSM state logging, artifact logging) and frontend (tool-specific debug panels, API call logging, state transition tracking).",
  "tier_0_contracts": [
    {
      "module": "shared.contracts.core.logging",
      "classes": [
        "LogEvent",
        "RequestContext",
        "StateSnapshot",
        "FSMTransitionLog",
        "ArtifactLog",
        "TraceQuery",
        "TraceResult"
      ],
      "note": "Backend logging contracts - IMPLEMENTED"
    },
    {
      "module": "shared.contracts.core.frontend_logging",
      "classes": [
        "FrontendLogEntry",
        "FrontendAPICall",
        "FrontendStateTransition",
        "FrontendDebugExport"
      ],
      "note": "Frontend logging contracts - NEW"
    }
  ],
  "logging_implementation": {
    "library": "structlog",
    "format": "JSON lines (one JSON object per log line)",
    "configuration": {
      "location": "shared/logging/config.py",
      "processors": [
        "structlog.processors.TimeStamper(fmt='iso')",
        "structlog.processors.add_log_level",
        "structlog.processors.JSONRenderer()"
      ],
      "context_class": "structlog.threadlocal.wrap_dict(dict)"
    },
    "required_fields": [
      "timestamp",
      "level",
      "event",
      "request_id"
    ],
    "recommended_fields": [
      "module",
      "function",
      "duration_ms"
    ],
    "context_specific_fields": [
      "stage_id",
      "artifact_id",
      "dataset_id",
      "error_type"
    ]
  },
  "request_tracing": {
    "header": "X-Request-ID",
    "generation": "uuid.uuid4() if not provided",
    "middleware_implementation": {
      "location": "gateway/middleware/request_id.py",
      "code_pattern": "@app.middleware('http')\nasync def request_id_middleware(request, call_next):\n    request_id = request.headers.get('X-Request-ID') or str(uuid.uuid4())\n    structlog.contextvars.bind_contextvars(request_id=request_id)\n    response = await call_next(request)\n    response.headers['X-Request-ID'] = request_id\n    return response"
    },
    "propagation": {
      "http_calls": "Include X-Request-ID header in all downstream calls",
      "background_tasks": "Pass request_id via task context",
      "logging": "Automatically included via structlog context"
    }
  },
  "fsm_state_logging": {
    "events": {
      "stage_transition_start": {
        "level": "INFO",
        "fields": [
          "stage_id",
          "from_state",
          "to_state",
          "trigger",
          "request_id"
        ]
      },
      "stage_transition_complete": {
        "level": "INFO",
        "fields": [
          "stage_id",
          "from_state",
          "to_state",
          "duration_ms",
          "artifacts_created"
        ]
      },
      "cascade_triggered": {
        "level": "INFO",
        "fields": [
          "source_stage_id",
          "affected_stages",
          "cascade_policy"
        ]
      },
      "state_snapshot": {
        "level": "DEBUG",
        "fields": [
          "stage_id",
          "full_state_json"
        ],
        "note": "Full state serialized; DEBUG level to control volume"
      }
    },
    "implementation": {
      "location": "shared/workflows/fsm_orchestrator.py",
      "pattern": "Emit log events at transition boundaries"
    }
  },
  "artifact_logging": {
    "events": {
      "artifact_write": {
        "level": "INFO",
        "fields": [
          "artifact_id",
          "content_hash",
          "file_path",
          "size_bytes",
          "request_id"
        ]
      },
      "artifact_read": {
        "level": "DEBUG",
        "fields": [
          "artifact_id",
          "file_path",
          "request_id"
        ]
      }
    },
    "implementation": {
      "location": "shared/storage/artifact_store.py",
      "pattern": "Log on every write with SHA-256 hash for verification"
    }
  },
  "error_logging": {
    "required_fields": [
      "exception_type",
      "exception_message",
      "stack_trace",
      "request_id",
      "context"
    ],
    "implementation": {
      "pattern": "try/except with structlog.exception()",
      "example": "except Exception as e:\n    logger.exception('Operation failed', error_type=type(e).__name__, context={'stage_id': stage_id})\n    raise"
    }
  },
  "devtools_trace_viewer": {
    "location": "apps/homepage/frontend/src/devtools/TraceViewer.tsx",
    "features": [
      "Filter by request_id",
      "Timeline view of stage transitions",
      "State diff viewer (before/after)",
      "Artifact content preview",
      "Log level filtering"
    ],
    "api_endpoints": {
      "get_logs": "GET /api/devtools/logs?request_id={id}",
      "get_trace": "GET /api/devtools/traces/{request_id}"
    },
    "implementation": {
      "backend": "gateway/services/devtools_service.py",
      "storage": "In-memory ring buffer (last N requests); file-based for persistence"
    }
  },
  "frontend_debugging": {
    "overview": "Each tool frontend includes a debug panel for real-time API call inspection and state transition logging during development.",
    "components": {
      "DebugContext": {
        "location": "apps/{tool}/frontend/src/components/debug/DebugContext.tsx",
        "purpose": "React Context provider for debug state management",
        "exports": [
          "DebugProvider",
          "useDebug",
          "useDebugOptional"
        ],
        "state": {
          "logs": "Array of FrontendLogEntry",
          "apiCalls": "Array of FrontendAPICall",
          "stateTransitions": "Array of FrontendStateTransition",
          "isEnabled": "boolean - whether logging is active",
          "isPanelOpen": "boolean - whether panel is expanded"
        },
        "methods": {
          "log": "(level, category, message, details?, source?) => void",
          "logAPI": "(entry) => string (returns call ID)",
          "updateAPI": "(id, updates) => void",
          "logStateTransition": "(from, to, trigger, payload?) => void",
          "clearLogs": "() => void",
          "togglePanel": "() => void",
          "setEnabled": "(enabled) => void",
          "exportLogs": "() => string (JSON)"
        }
      },
      "DebugPanel": {
        "location": "apps/{tool}/frontend/src/components/debug/DebugPanel.tsx",
        "purpose": "Floating debug panel UI for real-time inspection",
        "ui_structure": {
          "closed_state": "Floating bug icon button in bottom-right corner (fixed, z-50)",
          "open_state": "Expandable panel with header, tabs, and content area",
          "tabs": [
            "API Calls",
            "All Logs",
            "State Transitions"
          ],
          "features": [
            "Filter/search within current tab",
            "Copy logs to clipboard",
            "Export logs as JSON file",
            "Clear all logs",
            "Pause/resume logging",
            "Error indicator (red dot when errors present)"
          ]
        },
        "styling": {
          "framework": "TailwindCSS",
          "theme": "Dark slate theme for visibility",
          "position": "fixed bottom-0 right-0 (panel), fixed bottom-4 right-4 (button)"
        }
      },
      "useDebugFetch": {
        "location": "apps/{tool}/frontend/src/components/debug/useDebugFetch.ts",
        "purpose": "Fetch wrapper hook that automatically logs API calls",
        "usage": "const debugFetch = useDebugFetch(); await debugFetch(url, options);",
        "behavior": [
          "Logs request start with method, URL, body",
          "Logs response with status, body, duration",
          "Handles errors gracefully",
          "Falls back to normal fetch if debug context unavailable"
        ]
      }
    },
    "integration_pattern": {
      "app_tsx": "Wrap app content with <DebugProvider> and include <DebugPanel /> as sibling",
      "example": "<DebugProvider>\n  <div className=\"app-content\">...</div>\n  <DebugPanel />\n</DebugProvider>",
      "hooks_usage": "Replace fetch() calls with useDebugFetch() hook in all components"
    },
    "log_schemas": {
      "FrontendLogEntry": {
        "fields": {
          "id": "string - unique log ID",
          "timestamp": "Date - when logged",
          "level": "enum: info, warn, error, success, debug",
          "category": "enum: api, state, render, user, system",
          "message": "string - log message",
          "details": "any - optional additional data",
          "source": "string - optional source identifier"
        }
      },
      "FrontendAPICall": {
        "fields": {
          "id": "string - unique call ID",
          "timestamp": "Date - when request started",
          "method": "string - HTTP method",
          "url": "string - request URL",
          "requestBody": "any - request payload",
          "responseStatus": "number - HTTP status code",
          "responseBody": "any - response payload",
          "duration": "number - milliseconds",
          "error": "string - error message if failed",
          "pending": "boolean - whether still in flight"
        }
      },
      "FrontendStateTransition": {
        "fields": {
          "id": "string - unique transition ID",
          "timestamp": "Date - when transition occurred",
          "from": "string - previous state",
          "to": "string - new state",
          "trigger": "string - what caused the transition",
          "payload": "any - optional transition data"
        }
      },
      "FrontendDebugExport": {
        "fields": {
          "exportedAt": "string - ISO-8601 timestamp",
          "tool": "string - tool identifier (dat, sov, pptx)",
          "logs": "FrontendLogEntry[]",
          "apiCalls": "FrontendAPICall[]",
          "stateTransitions": "FrontendStateTransition[]"
        }
      }
    },
    "constraints": {
      "max_entries": 500,
      "auto_cleanup": "Oldest entries dropped when limit exceeded",
      "memory_safety": "All arrays capped to prevent memory leaks"
    }
  },
  "log_levels": {
    "DEBUG": "Detailed diagnostic (state snapshots, artifact reads)",
    "INFO": "Normal operations (transitions, writes)",
    "WARNING": "Unexpected but handled",
    "ERROR": "Failures requiring attention",
    "CRITICAL": "System-level failures"
  },
  "requirements": [
    {
      "id": "REQ-OBS-001",
      "description": "All log messages MUST be structured JSON via structlog"
    },
    {
      "id": "REQ-OBS-002",
      "description": "All API requests MUST have request_id propagated"
    },
    {
      "id": "REQ-OBS-003",
      "description": "FSM transitions MUST emit structured log events"
    },
    {
      "id": "REQ-OBS-004",
      "description": "ArtifactStore writes MUST log artifact_id and content_hash"
    },
    {
      "id": "REQ-OBS-005",
      "description": "DevTools MUST provide trace viewer"
    },
    {
      "id": "REQ-OBS-006",
      "description": "Each tool frontend MUST include DebugPanel component wrapped in DebugProvider"
    },
    {
      "id": "REQ-OBS-007",
      "description": "Frontend API calls MUST use useDebugFetch hook for automatic logging"
    },
    {
      "id": "REQ-OBS-008",
      "description": "Frontend FSM/wizard state transitions MUST log from/to states via logStateTransition"
    },
    {
      "id": "REQ-OBS-009",
      "description": "Debug logs MUST be exportable in unified FrontendDebugExport JSON format"
    },
    {
      "id": "REQ-OBS-010",
      "description": "Debug panel MUST always render floating button regardless of panel state"
    }
  ],
  "validation_commands": {
    "verify_structured_logs": "grep -v '^{' app.log | wc -l  # Should be 0",
    "test_request_id": "curl -H 'X-Request-ID: test-123' http://localhost:8000/health",
    "view_traces": "Open DevTools â†’ Traces tab",
    "verify_debug_panel_dat": "Check DAT tool at localhost:5173 for bug icon in bottom-right",
    "verify_debug_provider": "grep -r 'DebugProvider' apps/*/frontend/src/App.tsx",
    "verify_debug_fetch_usage": "grep -r 'useDebugFetch' apps/*/frontend/src/components/"
  },
  "references": [
    "ADR-0036_Observability-and-Debugging-First",
    "structlog: https://www.structlog.org/",
    "12-Factor App - Logs: https://12factor.net/logs"
  ],
  "tags": [
    "observability",
    "logging",
    "tracing",
    "structlog",
    "devtools",
    "frontend-debugging",
    "specification"
  ],
  "implements_adr": [
    "ADR-0010",
    "ADR-0037"
  ]
}