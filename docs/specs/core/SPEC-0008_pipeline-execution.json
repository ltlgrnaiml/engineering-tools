{
  "schema_type": "spec",
  "id": "SPEC-0008_pipeline-execution",
  "title": "Pipeline Execution and Error Handling Specification",
  "version": "0.1.0",
  "status": "draft",
  "date": "2025-12-27",
  "author": "Mycahya Eggleston",
  "implements_adr": [
    "ADR-0026_Pipeline-Error-Handling",
    "ADR-0007",
    "ADR-0010",
    "ADR-0017",
    "ADR-0030"
  ],
  "tier_0_contracts": [
    {
      "module": "shared.contracts.core.pipeline",
      "classes": [
        "Pipeline",
        "PipelineStep",
        "PipelineStepState",
        "PipelineError",
        "PipelineResult"
      ]
    }
  ],
  "purpose": "Define how pipelines execute across tools and handle errors consistently. This spec covers execution flow, error categorization, retry policies, and progress reporting.",
  "scope": "core",
  "requirements": [
    {
      "id": "REQ-EXEC-001",
      "description": "Pipeline execution MUST be resumable after failure",
      "implementation": "Steps track state; resume from last successful step"
    },
    {
      "id": "REQ-EXEC-002",
      "description": "Errors MUST be categorized for appropriate handling",
      "categories": [
        "TRANSIENT",
        "PERMANENT",
        "USER_ACTION_REQUIRED",
        "SYSTEM"
      ]
    },
    {
      "id": "REQ-EXEC-003",
      "description": "Transient errors MUST trigger automatic retry",
      "policy": "Exponential backoff, max 3 retries, configurable"
    },
    {
      "id": "REQ-EXEC-004",
      "description": "Progress MUST be reported via structured events",
      "events": [
        "step_started",
        "step_progress",
        "step_completed",
        "step_failed"
      ]
    },
    {
      "id": "REQ-EXEC-005",
      "description": "Cancellation MUST preserve completed work",
      "reference": "ADR-0014"
    }
  ],
  "error_categories": [
    {
      "category": "TRANSIENT",
      "description": "Temporary failures that may succeed on retry",
      "examples": [
        "Network timeout",
        "Resource temporarily unavailable"
      ],
      "action": "Auto-retry with backoff"
    },
    {
      "category": "PERMANENT",
      "description": "Failures that will not succeed on retry",
      "examples": [
        "Invalid input data",
        "Missing required columns"
      ],
      "action": "Fail step, require user correction"
    },
    {
      "category": "USER_ACTION_REQUIRED",
      "description": "Failures requiring user decision",
      "examples": [
        "Ambiguous column mapping",
        "Conflicting options"
      ],
      "action": "Pause pipeline, prompt user"
    },
    {
      "category": "SYSTEM",
      "description": "Internal system failures",
      "examples": [
        "Out of memory",
        "Disk full"
      ],
      "action": "Fail pipeline, alert admin"
    }
  ],
  "retry_policy": {
    "default": {
      "max_retries": 3,
      "initial_delay_ms": 1000,
      "backoff_multiplier": 2,
      "max_delay_ms": 30000
    },
    "per_error_type": {
      "TRANSIENT": "Use default policy",
      "PERMANENT": "No retry",
      "USER_ACTION_REQUIRED": "No retry, await user",
      "SYSTEM": "Single retry after 5s"
    }
  },
  "progress_reporting": {
    "events": [
      {
        "event": "pipeline_started",
        "payload": [
          "pipeline_id",
          "step_count"
        ]
      },
      {
        "event": "step_started",
        "payload": [
          "step_id",
          "step_name"
        ]
      },
      {
        "event": "step_progress",
        "payload": [
          "step_id",
          "percent_complete",
          "message"
        ]
      },
      {
        "event": "step_completed",
        "payload": [
          "step_id",
          "duration_ms",
          "artifacts"
        ]
      },
      {
        "event": "step_failed",
        "payload": [
          "step_id",
          "error_category",
          "error_message"
        ]
      },
      {
        "event": "pipeline_completed",
        "payload": [
          "pipeline_id",
          "total_duration_ms",
          "result"
        ]
      }
    ],
    "delivery": "WebSocket for real-time, poll endpoint for fallback"
  },
  "cancellation_behavior": {
    "soft_cancel": "Complete current operation, then stop",
    "hard_cancel": "Interrupt immediately (data loss possible)",
    "default": "soft_cancel",
    "artifact_preservation": "Per ADR-0002/ADR-0014, completed steps retain artifacts"
  },
  "references": [
    "ADR-0026_Pipeline-Error-Handling: WHY we categorize errors",
    "ADR-0013_Cancellation-Semantics: Cancellation behavior",
    "shared/contracts/core/pipeline.py: Tier-0 contracts"
  ]
}