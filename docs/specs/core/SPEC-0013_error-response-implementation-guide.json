{
  "schema_type": "spec",
  "id": "SPEC-0013_error-response-implementation-guide",
  "title": "Error Response Implementation Guide",
  "version": "0.1.0",
  "status": "active",
  "implements": "ADR-0032",
  "date": "2025-12-28",
  "scope": "core",
  "summary": "Technical specification for implementing standardized HTTP error responses across all tools in the Engineering Tools Platform.",
  "error_response_contract": {
    "location": "shared/contracts/core/error_response.py",
    "main_classes": {
      "ErrorResponse": {
        "description": "Main error response model",
        "fields": {
          "status_code": "int - HTTP status code",
          "category": "ErrorCategory - Error classification",
          "message": "str - Human-readable message",
          "details": "list[ErrorDetail] - Field-specific details (optional)",
          "timestamp": "datetime - When error occurred",
          "tool": "str | None - Tool name",
          "request_id": "str | None - Request ID for tracing",
          "severity": "ErrorSeverity - error/warning/info (default: error)"
        }
      },
      "ErrorCategory": {
        "description": "Enum for error classification",
        "values": [
          "VALIDATION - 400 errors",
          "NOT_FOUND - 404 errors",
          "CONFLICT - 409 errors",
          "PERMISSION - 403 errors",
          "RATE_LIMIT - 429 errors",
          "INTERNAL - 500 errors",
          "DEPENDENCY - 502/503 errors",
          "TIMEOUT - 504 errors",
          "CANCELLED - 499 errors"
        ]
      },
      "ErrorDetail": {
        "description": "Field-specific error detail",
        "fields": {
          "field": "str | None - Field name that caused error",
          "message": "str - Detail message",
          "code": "str | None - Error code",
          "context": "dict | None - Additional context"
        }
      }
    },
    "factory_function": {
      "name": "create_error_response",
      "description": "Factory function to create ErrorResponse with auto-detected category",
      "signature": "create_error_response(status_code, message, category=None, details=None, tool=None, request_id=None) -> ErrorResponse",
      "auto_category_mapping": {
        "404": "NOT_FOUND",
        "409": "CONFLICT",
        "403": "PERMISSION",
        "429": "RATE_LIMIT",
        "400-499": "VALIDATION",
        "500+": "INTERNAL"
      }
    }
  },
  "tool_helper_module_template": {
    "filename": "errors.py",
    "location": "apps/{tool}/backend/api/errors.py",
    "required_imports": [
      "from fastapi import HTTPException",
      "from shared.contracts.core.error_response import ErrorCategory, ErrorDetail, create_error_response"
    ],
    "required_constants": {
      "TOOL_NAME": "Tool identifier string (e.g., 'pptx', 'dat', 'sov')"
    },
    "required_functions": [
      {
        "name": "raise_error",
        "signature": "raise_error(status_code: int, message: str, category: ErrorCategory | None = None, field: str | None = None, details: list[ErrorDetail] | None = None) -> None",
        "description": "General error helper - always raises HTTPException"
      },
      {
        "name": "raise_not_found",
        "signature": "raise_not_found(resource_type: str, resource_id: str) -> None",
        "description": "404 Not Found helper"
      },
      {
        "name": "raise_validation_error",
        "signature": "raise_validation_error(message: str, field: str | None = None) -> None",
        "description": "400 Validation Error helper"
      },
      {
        "name": "raise_internal_error",
        "signature": "raise_internal_error(message: str, exception: Exception | None = None) -> None",
        "description": "500 Internal Error helper with optional exception context"
      },
      {
        "name": "raise_conflict_error",
        "signature": "raise_conflict_error(message: str) -> None",
        "description": "409 Conflict Error helper"
      }
    ]
  },
  "implementation_examples": {
    "pptx_errors_module": {
      "path": "apps/pptx_generator/backend/api/errors.py",
      "status": "implemented",
      "description": "Reference implementation for PPTX tool"
    },
    "usage_examples": {
      "not_found": {
        "before": "raise HTTPException(status_code=404, detail=f'Project {project_id} not found')",
        "after": "raise_not_found('Project', str(project_id))"
      },
      "validation": {
        "before": "raise HTTPException(status_code=400, detail='Invalid file type')",
        "after": "raise_validation_error('Invalid file type', field='file')"
      },
      "internal": {
        "before": "raise HTTPException(status_code=500, detail=f'Failed: {str(e)}') from e",
        "after": "raise_internal_error(f'Failed: {str(e)}', e)"
      },
      "conflict": {
        "before": "raise HTTPException(status_code=409, detail='Resource already exists')",
        "after": "raise_conflict_error('Resource already exists')"
      }
    }
  },
  "global_exception_handler": {
    "description": "Each tool's main.py should have a global exception handler using ErrorResponse",
    "example": {
      "code_pattern": "@app.exception_handler(Exception)\nasync def global_exception_handler(_request, exc):\n    from shared.contracts.core.error_response import create_error_response, ErrorCategory\n    error = create_error_response(\n        status_code=500,\n        message=f'Internal server error: {str(exc)}',\n        category=ErrorCategory.INTERNAL,\n        tool='TOOL_NAME',\n    )\n    return JSONResponse(status_code=500, content=error.model_dump(mode='json'))"
    }
  },
  "error_response_format": {
    "json_example": {
      "status_code": 404,
      "category": "not_found",
      "message": "Project not found: 123e4567-e89b-12d3-a456-426614174000",
      "details": [],
      "timestamp": "2025-12-28T15:30:00Z",
      "tool": "pptx",
      "request_id": null,
      "severity": "error"
    },
    "validation_error_example": {
      "status_code": 400,
      "category": "validation",
      "message": "Invalid file type. Allowed: ['.pptx']",
      "details": [
        {
          "field": "file",
          "message": "Invalid file type. Allowed: ['.pptx']",
          "code": null,
          "context": null
        }
      ],
      "timestamp": "2025-12-28T15:30:00Z",
      "tool": "pptx",
      "request_id": null,
      "severity": "error"
    }
  },
  "migration_checklist": {
    "per_tool": [
      "Create errors.py helper module in api/ directory",
      "Update all API files to import from errors.py",
      "Replace HTTPException(detail=str) with appropriate helper function",
      "Add ADR-0032 reference comment to module docstring",
      "Update global exception handler in main.py",
      "Test error responses return correct format"
    ],
    "tools_status": {
      "pptx": "✅ Completed",
      "dat": "⚠️ Partial (uses create_error_response directly)",
      "sov": "⚠️ Partial (uses _raise_error helper)",
      "gateway": "❌ Not started"
    }
  },
  "testing_requirements": [
    "Verify all 4xx/5xx responses match ErrorResponse schema",
    "Test each error helper function returns correct status code and category",
    "Test tool field is present in all error responses",
    "Test field name is included for validation errors",
    "Test internal errors include exception type in details"
  ],
  "frontend_integration": {
    "parsing_example": {
      "typescript": "interface ErrorResponse {\n  status_code: number;\n  category: string;\n  message: string;\n  details: ErrorDetail[];\n  timestamp: string;\n  tool: string | null;\n  request_id: string | null;\n  severity: string;\n}\n\nasync function handleApiError(response: Response): Promise<void> {\n  const error: ErrorResponse = await response.json();\n  if (error.category === 'validation' && error.details.length > 0) {\n    // Show field-specific errors\n    error.details.forEach(d => showFieldError(d.field, d.message));\n  } else {\n    // Show general error message\n    showError(error.message);\n  }\n}"
    }
  },
  "tags": [
    "api",
    "error-handling",
    "implementation",
    "specification"
  ],
  "implements_adr": [
    "ADR-0003",
    "ADR-0006",
    "ADR-0014",
    "ADR-0015",
    "ADR-0002"
  ]
}