{
  "schema_type": "spec",
  "id": "SPEC-0039",
  "title": "Contract-Driven Test Generation Specification",
  "version": "2025.12.001",
  "status": "active",
  "implements": "ADR-0035",
  "date": "2025-12-28",
  "scope": "core",
  "summary": "Technical specification for auto-generating tests from Pydantic contracts using Hypothesis and hypothesis-jsonschema, plus FSM exhaustive path testing.",
  "tier_0_contracts": [
    {
      "module": "shared.contracts",
      "note": "All Pydantic models are sources for test generation"
    }
  ],
  "test_generation_approaches": {
    "property_based_testing": {
      "tool": "hypothesis + hypothesis-jsonschema",
      "source": "Pydantic models → JSON Schema → Hypothesis strategy",
      "coverage": [
        "Valid inputs: Pydantic accepts without ValidationError",
        "Invalid inputs: Pydantic raises ValidationError",
        "Boundary values: min/max, numeric ranges, enum constraints",
        "Optional fields: present vs absent",
        "Nested models: recursive validation"
      ],
      "implementation": {
        "dependencies": ["hypothesis", "hypothesis-jsonschema"],
        "strategy_generation": "from_schema(model.model_json_schema())",
        "example_test": "@given(from_schema(DataSetManifest.model_json_schema()))\ndef test_dataset_manifest_valid(data):\n    manifest = DataSetManifest.model_validate(data)\n    assert manifest is not None"
      }
    },
    "serialization_roundtrip": {
      "description": "Test that models serialize and deserialize consistently",
      "assertions": [
        "model.model_dump_json() produces valid JSON",
        "Model.model_validate_json(json_str) reconstructs model",
        "model == Model.model_validate(model.model_dump())"
      ],
      "implementation": {
        "example_test": "@given(from_schema(DataSetManifest.model_json_schema()))\ndef test_roundtrip(data):\n    original = DataSetManifest.model_validate(data)\n    json_str = original.model_dump_json()\n    restored = DataSetManifest.model_validate_json(json_str)\n    assert original == restored"
      }
    },
    "fsm_transition_testing": {
      "tool": "Custom FSM test generator",
      "source": "Stage graph configuration (ADR-0001)",
      "coverage": [
        "All valid forward transitions succeed",
        "Invalid transitions (skipping stages) rejected",
        "Backward cascade triggers downstream resets",
        "Optional stages can be skipped"
      ],
      "implementation": {
        "script": "tools/gen_fsm_tests.py",
        "command": "python tools/gen_fsm_tests.py --config apps/data_aggregator/config/stages.json --output tests/dat/test_fsm_generated.py"
      }
    },
    "api_endpoint_testing": {
      "tool": "schemathesis",
      "source": "OpenAPI spec",
      "coverage": [
        "All endpoints respond to valid requests",
        "Invalid requests return appropriate 4xx errors",
        "Response bodies match declared schemas"
      ],
      "implementation": {
        "command": "schemathesis run http://localhost:8000/openapi.json",
        "ci_integration": "Run after server startup in CI"
      }
    }
  },
  "test_file_structure": {
    "contract_tests": {
      "location": "tests/contracts/",
      "naming": "test_{contract_module}.py",
      "example": {
        "contract": "shared/contracts/core/dataset.py",
        "test_file": "tests/contracts/test_dataset.py"
      }
    },
    "fsm_tests": {
      "location": "tests/{tool}/",
      "naming": "test_fsm_generated.py",
      "example": "tests/dat/test_fsm_generated.py"
    },
    "api_tests": {
      "location": "tests/integration/",
      "naming": "test_api_{tool}.py"
    }
  },
  "pytest_fixtures": {
    "contract_strategy_fixture": {
      "purpose": "Auto-discover contracts and generate Hypothesis strategies",
      "location": "tests/conftest.py",
      "implementation": "@pytest.fixture\ndef dataset_manifest_strategy():\n    return from_schema(DataSetManifest.model_json_schema())"
    },
    "auto_discovery": {
      "purpose": "Automatically find all Pydantic models in shared/contracts/",
      "implementation": "Inspect modules, find BaseModel subclasses, generate tests"
    }
  },
  "ci_enforcement": {
    "rules": [
      "CI MUST fail if new contract lacks corresponding test file",
      "CI MUST run property-based tests with limited examples (--hypothesis-profile=ci)",
      "CI MUST run schemathesis after server startup"
    ],
    "hypothesis_profiles": {
      "ci": {"max_examples": 50, "deadline": 500},
      "dev": {"max_examples": 100, "deadline": 1000},
      "thorough": {"max_examples": 1000, "deadline": null}
    }
  },
  "requirements": [
    {
      "id": "REQ-TEST-001",
      "description": "Every Pydantic contract MUST have auto-generated property-based tests"
    },
    {
      "id": "REQ-TEST-002",
      "description": "Tests MUST cover: valid input, invalid input, serialization roundtrip"
    },
    {
      "id": "REQ-TEST-003",
      "description": "FSM stage graphs MUST have exhaustive transition tests"
    },
    {
      "id": "REQ-TEST-004",
      "description": "API endpoints MUST be validated against OpenAPI via schemathesis"
    },
    {
      "id": "REQ-TEST-005",
      "description": "CI MUST fail if new contract lacks test file"
    }
  ],
  "validation_commands": {
    "run_contract_tests": "pytest tests/contracts/ -v",
    "run_fsm_tests": "pytest tests/dat/test_fsm_generated.py -v",
    "run_schemathesis": "schemathesis run http://localhost:8000/openapi.json --checks all",
    "generate_fsm_tests": "python tools/gen_fsm_tests.py"
  },
  "references": [
    "ADR-0035_Contract-Driven-Test-Generation",
    "Hypothesis: https://hypothesis.readthedocs.io/",
    "hypothesis-jsonschema: https://github.com/Zac-HD/hypothesis-jsonschema",
    "Schemathesis: https://schemathesis.readthedocs.io/",
    "tests/conftest.py"
  ],
  "tags": ["testing", "contracts", "property-based", "hypothesis", "automation", "specification"]
}
