{
  "$schema": "../../schemas/tech_spec.schema.json",
  "id": "SPEC-0005_deterministic-stage-id",
  "title": "Deterministic Stage ID Generation",
  "version": "1.0.0",
  "status": "accepted",
  "created_date": "2024-12-27",
  "updated_date": "2024-12-27",
  "implements_adr": [
    "ADR-0005",
    "ADR-0008"
  ],
  "tier_0_contracts": [
    {
      "module": "shared.contracts.core.id_generator",
      "classes": ["IDConfig", "IDAlgorithm", "compute_deterministic_id", "compute_content_hash", "verify_id_determinism"]
    }
  ],
  "overview": {
    "purpose": "Define the deterministic ID generation system for stages and artifacts",
    "scope": "All tools requiring reproducible content-addressed IDs"
  },
  "requirements": {
    "functional": [
      {
        "id": "SPEC-0005-F1",
        "description": "Same inputs MUST always produce same ID (idempotent)",
        "acceptance_criteria": [
          "compute_deterministic_id(inputs) == compute_deterministic_id(inputs)",
          "ID generation is pure function with no side effects"
        ]
      },
      {
        "id": "SPEC-0005-F2",
        "description": "IDs MUST use SHA-256 hashing of stable JSON serialization",
        "acceptance_criteria": [
          "Hash uses sorted keys for stability",
          "Default prefix length is 8 characters",
          "Full hash is 64 characters"
        ]
      },
      {
        "id": "SPEC-0005-F3",
        "description": "Each stage type has defined inputs for ID computation",
        "acceptance_criteria": [
          "UploadStageInputs: file_hash, file_name, file_size_bytes",
          "ParseStageInputs: upload_stage_id, profile_id, profile_version",
          "ExportStageInputs: validate_stage_id, export_format"
        ]
      },
      {
        "id": "SPEC-0005-F4",
        "description": "Default seed is 42 for determinism",
        "acceptance_criteria": [
          "IDConfig.seed defaults to 42",
          "Different seeds produce different IDs"
        ]
      }
    ],
    "non_functional": [
      {
        "id": "SPEC-0005-NF1",
        "description": "ID generation MUST complete in <1ms",
        "acceptance_criteria": [
          "Performance tests verify sub-millisecond generation"
        ]
      }
    ]
  },
  "api_contracts": {
    "functions": [
      {
        "name": "compute_deterministic_id",
        "signature": "compute_deterministic_id(inputs: dict, seed: int = 42, prefix_length: int = 8, namespace: str | None = None) -> str",
        "description": "Compute deterministic ID from inputs"
      },
      {
        "name": "compute_content_hash",
        "signature": "compute_content_hash(content: bytes | str) -> str",
        "description": "Compute SHA-256 hash of content (64 chars)"
      },
      {
        "name": "verify_id_determinism",
        "signature": "verify_id_determinism(inputs: dict, expected_id: str, seed: int = 42, prefix_length: int = 8) -> bool",
        "description": "Verify inputs produce expected ID"
      }
    ],
    "models": [
      "IDConfig",
      "IDAlgorithm",
      "IDGenerationRequest",
      "IDGenerationResult",
      "StageIDInputs",
      "UploadStageInputs",
      "ParseStageInputs",
      "ExportStageInputs"
    ]
  },
  "test_requirements": [
    "test_same_inputs_produce_same_id",
    "test_different_inputs_produce_different_ids",
    "test_seed_affects_output",
    "test_default_seed_is_42",
    "test_input_order_independence"
  ]
}