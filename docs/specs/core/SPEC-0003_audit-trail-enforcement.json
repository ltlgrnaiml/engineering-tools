{
  "schema_type": "spec",
  "id": "SPEC-0003_audit-trail-enforcement",
  "title": "Audit Trail Enforcement Specification",
  "version": "0.1.0",
  "status": "draft",
  "date": "2025-12-27",
  "author": "Mycahya Eggleston",
  "implements_adr": [
    "ADR-0004",
    "ADR-0008"
  ],
  "tier_0_contracts": [
    {
      "module": "shared.contracts.core.audit",
      "classes": [
        "AuditTimestamp",
        "AuditTrail",
        "LifecycleEvent",
        "TimestampMixin"
      ],
      "functions": [
        "now_utc",
        "to_iso8601"
      ]
    }
  ],
  "purpose": "Define the implementation details for audit trail timestamps across all tools. This spec describes WHAT timestamp fields are required, WHERE they are stored, and HOW they are validated.",
  "scope": "core",
  "requirements": [
    {
      "id": "REQ-AUDIT-001",
      "description": "All artifacts MUST include created_at timestamp",
      "contract_field": "TimestampMixin.created_at",
      "validation": "ISO-8601 UTC, no microseconds"
    },
    {
      "id": "REQ-AUDIT-002",
      "description": "All state changes MUST be logged with timestamp",
      "contract_field": "AuditTrail.events",
      "validation": "Append-only list of AuditTimestamp entries"
    },
    {
      "id": "REQ-AUDIT-003",
      "description": "Timestamps MUST use ISO-8601 UTC format without microseconds",
      "format": "YYYY-MM-DDTHH:MM:SSZ",
      "examples": [
        "2025-12-27T14:30:00Z"
      ]
    },
    {
      "id": "REQ-AUDIT-004",
      "description": "Lifecycle events MUST use LifecycleEvent enum values",
      "allowed_values": [
        "created",
        "updated",
        "locked",
        "unlocked",
        "cancelled",
        "completed",
        "failed",
        "archived"
      ]
    }
  ],
  "api_endpoints": [
    {
      "method": "GET",
      "path": "/api/v1/{tool}/artifacts/{id}/audit",
      "description": "Retrieve audit trail for an artifact",
      "response_contract": "AuditTrail"
    }
  ],
  "storage": {
    "location": "manifest.json alongside artifact",
    "field": "audit_trail",
    "format": "JSON array of AuditTimestamp objects"
  },
  "validation_rules": [
    "CI MUST reject artifacts without created_at timestamp",
    "CI MUST validate timestamp format matches ISO-8601 UTC",
    "CI MUST verify no microseconds in timestamps"
  ],
  "examples": {
    "audit_timestamp": {
      "event": "created",
      "timestamp": "2025-12-27T14:30:00Z",
      "actor": "user:mycahya",
      "details": "Initial creation via DAT parse stage"
    },
    "audit_trail": {
      "events": [
        {
          "event": "created",
          "timestamp": "2025-12-27T14:30:00Z",
          "actor": "system"
        },
        {
          "event": "locked",
          "timestamp": "2025-12-27T14:35:00Z",
          "actor": "user:mycahya"
        },
        {
          "event": "unlocked",
          "timestamp": "2025-12-27T15:00:00Z",
          "actor": "user:mycahya",
          "details": "Re-running with new parameters"
        }
      ]
    }
  },
  "references": [
    "ADR-0008_Audit-Trail-Timestamps: WHY we need audit trails",
    "shared/contracts/core/audit.py: Tier-0 contracts",
    "ADR-0017_Cross-Cutting-Guardrails#audit-trail: Cross-cutting guardrail"
  ]
}