{
  "schema_type": "spec",
  "id": "SPEC-0024_dat-stage-graph",
  "title": "DAT 8-Stage Pipeline Graph Specification",
  "version": "1.0.0",
  "status": "accepted",
  "date": "2025-12-28",
  "author": "Mycahya Eggleston",
  "implements_adr": [
    "ADR-0003_stage-graph-configuration",
    "ADR-0004_optional-context-preview-stages",
    "ADR-0006_stage-id-configuration",
    "ADR-0008_table-availability",
    "ADR-0015_parse-and-export-artifact-formats"
  ],
  "tier_0_contracts": [
    {
      "module": "shared.contracts.dat.stage",
      "classes": [
        "DATStageState",
        "DATStageType",
        "DATStageConfig",
        "DATStageResult",
        "DiscoveryStageConfig",
        "SelectionStageConfig",
        "ContextStageConfig",
        "TableAvailabilityStageConfig",
        "TableSelectionStageConfig",
        "PreviewStageConfig",
        "ParseStageConfig",
        "ExportStageConfig"
      ]
    }
  ],
  "purpose": "Define the DAT-specific 8-stage pipeline for data extraction. This extends the core FSM pattern with DAT-specific stages, dependencies, and configurations per ADR-0004.",
  "scope": "subsystem:DAT",
  "stages": [
    {
      "order": 1,
      "name": "DISCOVERY",
      "type": "DATStageType.DISCOVERY",
      "optional": false,
      "description": "Automatic file system scan"
    },
    {
      "order": 2,
      "name": "SELECTION",
      "type": "DATStageType.SELECTION",
      "optional": false,
      "description": "User selects files to include"
    },
    {
      "order": 3,
      "name": "CONTEXT",
      "type": "DATStageType.CONTEXT",
      "optional": true,
      "description": "Optional context hints and metadata"
    },
    {
      "order": 4,
      "name": "TABLE_AVAILABILITY",
      "type": "DATStageType.TABLE_AVAILABILITY",
      "optional": false,
      "description": "Probe files to detect available tables"
    },
    {
      "order": 5,
      "name": "TABLE_SELECTION",
      "type": "DATStageType.TABLE_SELECTION",
      "optional": false,
      "description": "User selects tables to extract"
    },
    {
      "order": 6,
      "name": "PREVIEW",
      "type": "DATStageType.PREVIEW",
      "optional": true,
      "description": "Optional preview of extraction results"
    },
    {
      "order": 7,
      "name": "PARSE",
      "type": "DATStageType.PARSE",
      "optional": false,
      "description": "Execute full extraction to Parquet"
    },
    {
      "order": 8,
      "name": "EXPORT",
      "type": "DATStageType.EXPORT",
      "optional": false,
      "description": "Generate deliverables in user-selected formats"
    }
  ],
  "requirements": [
    {
      "id": "REQ-DAT-001",
      "description": "Optional stages (CONTEXT, PREVIEW) MUST use defaults when skipped",
      "reference": "ADR-0004"
    },
    {
      "id": "REQ-DAT-002",
      "description": "PARSE stage MUST produce Parquet output",
      "reference": "ADR-0015"
    },
    {
      "id": "REQ-DAT-003",
      "description": "Stage IDs MUST be deterministic based on inputs",
      "reference": "ADR-0008"
    },
    {
      "id": "REQ-DAT-004",
      "description": "TABLE_AVAILABILITY status check MUST complete in < 1 second per table",
      "reference": "ADR-0008"
    },
    {
      "id": "REQ-DAT-005",
      "description": "EXPORT requires PARSE to be locked and completed",
      "reference": "ADR-0004"
    },
    {
      "id": "REQ-DAT-006",
      "description": "Unlocking a stage cascades to downstream stages per unlock_cascade policy",
      "reference": "ADR-0004"
    }
  ],
  "stage_dependencies": {
    "DISCOVERY": [],
    "SELECTION": [
      "DISCOVERY"
    ],
    "CONTEXT": [
      "SELECTION"
    ],
    "TABLE_AVAILABILITY": [
      "SELECTION"
    ],
    "TABLE_SELECTION": [
      "TABLE_AVAILABILITY"
    ],
    "PREVIEW": [
      "TABLE_SELECTION"
    ],
    "PARSE": [
      "TABLE_SELECTION"
    ],
    "EXPORT": [
      "PARSE"
    ]
  },
  "cascade_targets": {
    "DISCOVERY": [
      "SELECTION",
      "CONTEXT",
      "TABLE_AVAILABILITY",
      "TABLE_SELECTION",
      "PREVIEW",
      "PARSE",
      "EXPORT"
    ],
    "SELECTION": [
      "CONTEXT",
      "TABLE_AVAILABILITY",
      "TABLE_SELECTION",
      "PREVIEW",
      "PARSE",
      "EXPORT"
    ],
    "CONTEXT": [],
    "TABLE_AVAILABILITY": [
      "TABLE_SELECTION",
      "PREVIEW",
      "PARSE",
      "EXPORT"
    ],
    "TABLE_SELECTION": [
      "PREVIEW",
      "PARSE",
      "EXPORT"
    ],
    "PREVIEW": [],
    "PARSE": [
      "EXPORT"
    ],
    "EXPORT": []
  },
  "references": [
    "SPEC-0001_Stage-Orchestration-FSM: Base FSM pattern",
    "shared/contracts/dat/stage.py: Tier-0 contracts"
  ]
}